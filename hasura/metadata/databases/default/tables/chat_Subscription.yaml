table:
  schema: chat
  name: Subscription
object_relationships:
  - name: XPin
    using:
      manual_configuration:
        remote_table:
          schema: chat
          name: Pin
        insertion_order: null
        column_mapping:
          chatId: chatId
          registrantId: registrantId
  - name: chat
    using:
      foreign_key_constraint_on: chatId
  - name: registrant
    using:
      foreign_key_constraint_on: registrantId
insert_permissions:
  - role: attendee
    permission:
      check:
        _and:
          - chat:
              _and:
                - _or:
                    - _and:
                        - conferenceId:
                            _in: X-Hasura-Conference-Ids
                        - subconferenceId:
                            _is_null: true
                    - _and:
                        - subconferenceId:
                            _is_null: false
                        - conferenceId:
                            _in: X-Hasura-Conference-Ids
                        - subconferenceId:
                            _in: X-Hasura-Subconference-Ids
                - _or:
                    - _not:
                        room: {}
                    - room:
                        id:
                          _in: X-Hasura-Room-Ids
          - registrantId:
              _in: X-Hasura-Registrant-Ids
      set:
        wasManuallySubscribed: "true"
      columns:
        - chatId
        - registrantId
      backend_only: false
  - role: conference-organizer
    permission:
      check:
        _and:
          - chat:
              _and:
                - conferenceId:
                    _in: X-Hasura-Conference-Ids
                - subconferenceId:
                    _is_null: true
          - registrant:
              _and:
                - conferenceId:
                    _in: X-Hasura-Conference-Ids
                - subconferenceMemberships:
                    subconferenceId:
                      _in: X-Hasura-Subconference-Ids
      set:
        wasManuallySubscribed: "true"
      columns:
        - chatId
        - registrantId
      backend_only: false
  - role: subconference-organizer
    permission:
      check:
        _and:
          - chat:
              _and:
                - subconferenceId:
                    _is_null: false
                - conferenceId:
                    _in: X-Hasura-Conference-Ids
                - subconferenceId:
                    _in: X-Hasura-Subconference-Ids
          - registrant:
              _and:
                - conferenceId:
                    _in: X-Hasura-Conference-Ids
                - subconferenceMemberships:
                    subconferenceId:
                      _in: X-Hasura-Subconference-Ids
      set:
        wasManuallySubscribed: "true"
      columns:
        - chatId
        - registrantId
      backend_only: false
select_permissions:
  - role: attendee
    permission:
      columns:
        - wasManuallySubscribed
        - created_at
        - chatId
        - registrantId
      filter:
        registrantId:
          _in: X-Hasura-Registrant-Ids
  - role: conference-organizer
    permission:
      columns:
        - wasManuallySubscribed
        - created_at
        - chatId
        - registrantId
      filter:
        _and:
          - chat:
              _and:
                - conferenceId:
                    _in: X-Hasura-Conference-Ids
                - subconferenceId:
                    _is_null: true
          - registrant:
              _and:
                - conferenceId:
                    _in: X-Hasura-Conference-Ids
                - subconferenceMemberships:
                    subconferenceId:
                      _in: X-Hasura-Subconference-Ids
  - role: subconference-organizer
    permission:
      columns:
        - wasManuallySubscribed
        - created_at
        - chatId
        - registrantId
      filter:
        _and:
          - chat:
              _and:
                - subconferenceId:
                    _is_null: false
                - conferenceId:
                    _in: X-Hasura-Conference-Ids
                - subconferenceId:
                    _in: X-Hasura-Subconference-Ids
          - registrant:
              _and:
                - conferenceId:
                    _in: X-Hasura-Conference-Ids
                - subconferenceMemberships:
                    subconferenceId:
                      _in: X-Hasura-Subconference-Ids
update_permissions:
  - role: attendee
    permission:
      columns:
        - wasManuallySubscribed
      filter:
        registrantId:
          _in: X-Hasura-Registrant-Ids
      check: null
delete_permissions:
  - role: attendee
    permission:
      filter:
        _and:
          - registrantId:
              _in: X-Hasura-Registrant-Ids
          - chat:
              enableMandatorySubscribe:
                _eq: false
  - role: conference-organizer
    permission:
      filter:
        _and:
          - chat:
              _or:
                - _and:
                    - conferenceId:
                        _in: X-Hasura-Conference-Ids
                    - subconferenceId:
                        _is_null: true
          - chat:
              enableMandatorySubscribe:
                _eq: true
  - role: subconference-organizer
    permission:
      filter:
        _and:
          - chat:
              _or:
                - _and:
                    - subconferenceId:
                        _is_null: false
                    - conferenceId:
                        _in: X-Hasura-Conference-Ids
                    - subconferenceId:
                        _in: X-Hasura-Subconference-Ids
          - chat:
              enableMandatorySubscribe:
                _eq: false
event_triggers:
  - name: Cache_ChatSubscription
    definition:
      enable_manual: true
      insert:
        columns: '*'
      delete:
        columns: '*'
    retry_conf:
      num_retries: 3
      interval_sec: 10
      timeout_sec: 10
    webhook: '{{CACHES_BASE_URL}}/cache/update/chatSubscription'
    headers:
      - name: x-hasura-event-secret
        value_from_env: EVENT_SECRET
  - name: Realtime_ChatSubscription
    definition:
      enable_manual: true
      insert:
        columns: '*'
      delete:
        columns: '*'
    retry_conf:
      num_retries: 0
      interval_sec: 10
      timeout_sec: 60
    webhook: '{{REALTIME_BASE_URL}}/chat/subscriptionChanged'
    headers:
      - name: x-hasura-event-secret
        value_from_env: EVENT_SECRET
